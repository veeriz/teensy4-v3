[env:teensy40]
platform = teensy
board = teensy40
framework = arduino
upload_protocol = teensy-cli
lib_deps =
    https://github.com/tonton81/FlexCAN_T4.git

; Build flags including include paths
build_flags = 
    -D USB_SERIAL
    -D TEENSY_OPT_FASTEST
    -I include
    -I src
    -D CAN_BAUDRATE=500000
    -D CAN_RX_QUEUE_SIZE=32
    -D CAN_TX_QUEUE_SIZE=16
    -D CAN_ERROR_THRESHOLD=100
    -D CAN_TIMEOUT_MS=1000

; ARM-specific compiler flags
build_unflags =
    -fno-exceptions
    -fno-rtti
    -Os

build_flags =
    ${env:teensy40.build_flags}
    ; ARM Cortex-M7 flags
    -mthumb 
    -mcpu=cortex-m7
    -mfloat-abi=hard
    -mfpu=fpv5-d16
    ; C++ flags
    -std=gnu++14
    -fexceptions
    -frtti
    -O2
    ; Linker flags for ARM
    -Wl,--gc-sections
    -Wl,--relax
    -Wl,--print-memory-usage
    -Wl,--defsym=__rtc_localtime=0
    -Wl,-u_printf_float
    -Wl,-u_scanf_float
    ; Exception handling flags
    -ffunction-sections
    -fdata-sections
    -fno-common
    -fstack-usage

; Debug options
debug_build_flags = -O0 -g2 -ggdb2