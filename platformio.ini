[env:teensy40]
platform = teensy
board = teensy40
framework = arduino
upload_protocol = teensy-cli
lib_deps =
    https://github.com/tonton81/FlexCAN_T4.git

; Build configuration
build_unflags =
    -fno-exceptions
    -fno-rtti
    -Os

build_flags = 
    ; Definitions
    -D USB_SERIAL
    -D TEENSY_OPT_FASTEST
    -D CAN_BAUDRATE=500000
    -D CAN_RX_QUEUE_SIZE=32
    -D CAN_TX_QUEUE_SIZE=16
    -D CAN_ERROR_THRESHOLD=100
    -D CAN_TIMEOUT_MS=1000

    ; Include paths
    -I include
    -I src

    ; ARM Cortex-M7 flags
    -mthumb 
    -mcpu=cortex-m7
    -mfloat-abi=hard
    -mfpu=fpv5-d16

    ; Optimization and debug flags
    -O2
    -g

    ; Language-specific flags
    -std=gnu++14
    -fexceptions
    -frtti

    ; ARM EABI specific flags
    -fno-strict-aliasing
    -fno-strict-overflow
    -fomit-frame-pointer
    -fno-unwind-tables
    -fno-asynchronous-unwind-tables

    ; Linker flags
    -Wl,--gc-sections
    -Wl,--relax
    -Wl,--print-memory-usage
    -Wl,--defsym=__rtc_localtime=0
    -Wl,-u,_printf_float
    -Wl,-u,_scanf_float

    ; Section handling
    -ffunction-sections
    -fdata-sections
    -fno-common

; Debug configuration
debug_build_flags = -O0 -g3 -ggdb3